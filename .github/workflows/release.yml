name: Release

  on:
    push:
      branches: [main]
    workflow_dispatch:
      inputs:
        version_override:
          description: "Version override (e.g., 1.0.0). Leave empty for auto-increment."
          required: false
          type: string
        release_type:
          description: "Release type for auto-increment"
          required: false
          default: "patch"
          type: choice
          options:
            - patch
            - minor
            - major

  concurrency:
    group: release
    cancel-in-progress: false

  permissions:
    contents: write
    id-token: write

  jobs:
    release:
      runs-on: ubuntu-latest
      environment: npm-publish

      steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
            token: ${{ secrets.GITHUB_TOKEN }}

        - name: Setup pnpm
          uses: pnpm/action-setup@v4

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: "20"
            cache: "pnpm"
            registry-url: "https://registry.npmjs.org"

        - name: Install dependencies
          run: pnpm install --frozen-lockfile

        - name: Run CI checks
          run: |
            pnpm typecheck
            pnpm lint
            pnpm format:check
            pnpm build
            pnpm test

        - name: Determine version
          id: version
          working-directory: packages/sdk-react-native
          run: |
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

            if [ -n "${{ github.event.inputs.version_override }}" ]; then
              NEW_VERSION="${{ github.event.inputs.version_override }}"
              echo "Using override version: $NEW_VERSION"
            else
              RELEASE_TYPE="${{ github.event.inputs.release_type || 'patch' }}"

              IFS='.-' read -ra PARTS <<< "$CURRENT_VERSION"
              MAJOR=${PARTS[0]}
              MINOR=${PARTS[1]}
              PATCH=${PARTS[2]}
              PRERELEASE="${PARTS[3]:-}"
              PRERELEASE_NUM="${PARTS[4]:-}"

              if [ -n "$PRERELEASE" ]; then
                if [ -n "$PRERELEASE_NUM" ]; then
                  NEW_PRERELEASE_NUM=$((PRERELEASE_NUM + 1))
                  NEW_VERSION="$MAJOR.$MINOR.$PATCH-$PRERELEASE.$NEW_PRERELEASE_NUM"
                else
                  NEW_VERSION="$MAJOR.$MINOR.$PATCH-$PRERELEASE.1"
                fi
              else
                case "$RELEASE_TYPE" in
                  major)
                    NEW_VERSION="$((MAJOR + 1)).0.0"
                    ;;
                  minor)
                    NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
                    ;;
                  patch)
                    NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
                    ;;
                esac
              fi
              echo "Auto-incrementing $RELEASE_TYPE: $CURRENT_VERSION -> $NEW_VERSION"
            fi

            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

        - name: Update package.json version
          working-directory: packages/sdk-react-native
          run: |
            npm version ${{ steps.version.outputs.new_version }} --no-git-tag-version

        - name: Rebuild with new version
          run: pnpm build

        - name: Debug npm auth presence
          run: |
            if [ -f ~/.npmrc ]; then
              grep -q "_authToken" ~/.npmrc && echo "authToken present in ~/.npmrc" || echo "no authToken in ~/.npmrc"
            else
              echo "~/.npmrc not present"
            fi
            node -e "console.log('NODE_AUTH_TOKEN set:', !!process.env.NODE_AUTH_TOKEN)"

        - name: Publish to npm
          working-directory: packages/sdk-react-native
          run: npm publish --provenance --access public

        - name: Commit version bump
          run: |
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add packages/sdk-react-native/package.json
            git commit -m "chore(release): @harkenapp/sdk-react-native@${{ steps.version.outputs.new_version }}"
            git tag "sdk-react-native-v${{ steps.version.outputs.new_version }}"
            git push
            git push --tags

        - name: Create GitHub Release
          uses: softprops/action-gh-release@v2
          with:
            tag_name: "sdk-react-native-v${{ steps.version.outputs.new_version }}"
            name: "@harkenapp/sdk-react-native v${{ steps.version.outputs.new_version }}"
            generate_release_notes: true
