name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      version_override:
        description: "Version override (e.g., 1.0.0). Leave empty for auto-increment."
        required: false
        type: string
      release_type:
        description: "Release type for auto-increment"
        required: false
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write # For git operations
  id-token: write # For npm provenance

jobs:
  release:
    runs-on: ubuntu-latest
    environment: npm-publish # Environment with npm trusted publishing configured

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run CI checks
        run: |
          pnpm typecheck
          pnpm lint
          pnpm format:check
          pnpm build
          pnpm test

      - name: Determine version
        id: version
        working-directory: packages/sdk-react-native
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version(2)=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          if [ -n "${{ github.event.inputs.version_override }}" ]; then
            NEW_VERSION="${{ github.event.inputs.version_override }}"
            echo "Using override version: $NEW_VERSION"
          else
            RELEASE_TYPE="${{ github.event.inputs.release_type || 'patch' }}"

            # Parse semver and increment
            IFS='.-' read -ra PARTS <<< "$CURRENT_VERSION"
            MAJOR=${PARTS[0]}
            MINOR=${PARTS[1]}
            PATCH=${PARTS[2]}
            PRERELEASE="${PARTS[3]:-}"
            PRERELEASE_NUM="${PARTS[4]:-}"

            if [ -n "$PRERELEASE" ]; then
              # If current is prerelease (e.g., 0.0.1-alpha.1), increment prerelease
              if [ -n "$PRERELEASE_NUM" ]; then
                NEW_PRERELEASE_NUM=$((PRERELEASE_NUM + 1))
                NEW_VERSION="$MAJOR.$MINOR.$PATCH-$PRERELEASE.$NEW_PRERELEASE_NUM"
              else
                NEW_VERSION="$MAJOR.$MINOR.$PATCH-$PRERELEASE.1"
              fi
            else
              # Standard semver increment
              case "$RELEASE_TYPE" in
                major)
                  NEW_VERSION="$((MAJOR + 1)).0.0"
                  ;;
                minor)
                  NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
                  ;;
                patch)
                  NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
                  ;;
              esac
            fi
            echo "Auto-incrementing $RELEASE_TYPE: $CURRENT_VERSION -> $NEW_VERSION"
          fi

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update package.json version
        working-directory: packages/sdk-react-native
        run: |
          npm version ${{ steps.version.outputs.new_version }} --no-git-tag-version

      - name: Rebuild with new version
        run: pnpm build

      - name: Debug npm auth presence
        run: |
          if [ -f ~/.npmrc ]; then
            grep -q "_authToken" ~/.npmrc && echo "authToken present in ~/.npmrc" || echo "no authToken in ~/.npmrc"
          else
            echo "~/.npmrc not present"
          fi
          node -e "console.log('NODE_AUTH_TOKEN set:', !!process.env.NODE_AUTH_TOKEN)"

      - name: Debug token env names
        run: env | cut -d= -f1 | grep -i -E "token|npm" || true

      - name: Debug npm version
        run: npm --version

      - name: Debug npm provenance config
        run: npm config get provenance

      - name: Debug npm config source
        run: npm config list -l | grep -i -E "provenance|registry|userconfig" || true

      - name: Debug OIDC claims (safe)
        env:
          AUDIENCE: npm
        run: |
          TOKEN_JSON=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${AUDIENCE}")
          export TOKEN_JSON
          python -c 'import os,json,base64; token=json.loads(os.environ["TOKEN_JSON"])["value"]; payload=token.split(".")[1]; pad="="*((4-len(payload)%4)%4); data=json.loads(base64.urlsafe_b64decode(payload+pad)); keys=["repository","repository_owner","job_workflow_ref","workflow_ref","environment","ref","actor","sub","aud"]; [print(f"{k}: {data[k]}") for k in keys if k in data]'

      - name: Force OIDC (remove npmrc)
        run: |
          unset NODE_AUTH_TOKEN NPM_TOKEN
          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ]; then
            rm -f "$NPM_CONFIG_USERCONFIG"
            unset NPM_CONFIG_USERCONFIG
          fi
          rm -f ~/.npmrc

      - name: Publish to npm
        working-directory: packages/sdk-react-native
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ""
          NPM_TOKEN: ""
          NPM_CONFIG_USERCONFIG: ""
          NPM_CONFIG_PROVENANCE: "true"

      # Commit and tag ONLY after successful publish to avoid repo/npm state divergence.
      # If publish fails, package.json has the bumped version locally but nothing is committed,
      # so the next run will attempt the same version again (which is correct behavior).
      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/sdk-react-native/package.json
          git commit -m "chore(release): @harkenapp/sdk-react-native@${{ steps.version.outputs.new_version }}"
          git tag "sdk-react-native-v${{ steps.version.outputs.new_version }}"
          git push
          git push --tags

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "sdk-react-native-v${{ steps.version.outputs.new_version }}"
          name: "@harkenapp/sdk-react-native v${{ steps.version.outputs.new_version }}"
          generate_release_notes: true
